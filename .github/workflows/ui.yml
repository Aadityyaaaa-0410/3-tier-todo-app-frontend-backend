name: Deploy React App to S3
on:
  push:
    branches:
      - master
    paths:
      - 'frontend/**'

# Add permissions for OIDC token
permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for checkout

jobs:
  deploy:
    runs-on: ubuntu-latest   # GitHub-hosted runner
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '25'
      
      # Configure AWS credentials using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActionsDeployment
      
      - name: Install & Build
        run: |
          npm ci
          npm run build
      
      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete
      
      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
      
      - name: Health Check Validation
        run: |
          echo "‚è≥ Waiting for CloudFront invalidation to propagate..."
          sleep 30
          
          CLOUDFRONT_URL="${{ secrets.CLOUDFRONT_URL }}"
          
          echo "üîç Performing health check on: $CLOUDFRONT_URL"
          
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$CLOUDFRONT_URL")
          
          echo "üìä Status Code: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ Health check passed! Deployment successful."
            exit 0
          else
            echo "‚ùå Health check failed! Expected 200, got $HTTP_STATUS"
            exit 1
          fi
