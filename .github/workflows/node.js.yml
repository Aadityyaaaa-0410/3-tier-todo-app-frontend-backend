name: Deploy to AWS CodeDeploy

on:
  push:
    branches:
      - master  # ← Your branch
    paths:
      - 'backend/**'  # ← Only trigger on backend changes
  workflow_dispatch:  # ← Manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
      - name: Trigger CodeDeploy Deployment
        id: deploy
        run: |
          echo "Triggering CodeDeploy deployment..."

          DEPLOY_ID=$(aws deploy create-deployment \
            --application-name ${{ secrets.CODEDEPLOY_APPLICATION }} \
            --deployment-group-name ${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --s3-location bucket=code-deployy1143,key=cd.zip,bundleType=zip \
            --description "GitHub Actions - ${{ github.sha }}" \
            --query 'deploymentId' --output text)

          echo "Deployment ID: $DEPLOY_ID"
          echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

          echo "CodeDeploy deployment triggered successfully!"

      # ──────────────────────────────
      # OPTIONAL: Wait for Success
      # ──────────────────────────────
      - name: Wait for CodeDeploy Success
        if: success()
        run: |
          echo "Waiting for CodeDeploy to complete..."
          aws deploy wait deployment-successful --deployment-id ${{ steps.deploy.outputs.deployment_id }}
          echo "Deployment succeeded!"

      # ──────────────────────────────
      # OPTIONAL: On Failure
      # ──────────────────────────────
      - name: Deployment Failed
        if: failure()
        run: |
          echo "Deployment failed or timed out!"
          echo "Check CodeDeploy console: https://console.aws.amazon.com/codedeploy/home#/deployments/${{ steps.deploy.outputs.deployment_id }}"
          exit 1
