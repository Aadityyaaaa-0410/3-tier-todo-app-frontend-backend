name: Blue-Green Deploy React App to S3

on:
  push:
    branches: [ master ]
    paths: [ 'frontend/**' ]

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./frontend

    steps:
      # ------------------------------------------------------------------
      # 1. Checkout & build
      # ------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: Install & Build
        run: |
          npm ci
          npm run build

      # ------------------------------------------------------------------
      # 2. Validate secrets
      # ------------------------------------------------------------------
      - name: Validate Required Secrets
        run: |
          MISSING=()
          [[ -z "${{ secrets.S3_BUCKET_NAME_NEW }}" ]] && MISSING+=("S3_BUCKET_NAME_NEW")
          [[ -z "${{ secrets.S3_BUCKET_NAME }}" ]]    && MISSING+=("S3_BUCKET_NAME")
          [[ -z "${{ secrets.AWS_REGION }}" ]]       && MISSING+=("AWS_REGION")
          [[ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]] && MISSING+=("CLOUDFRONT_DISTRIBUTION_ID")
          [[ -z "${{ secrets.CLOUDFRONT_URL }}" ]]    && MISSING+=("CLOUDFRONT_URL")

          if (( ${#MISSING[@]} )); then
            echo "Missing secrets:" "${MISSING[@]}"
            exit 1
          fi
          echo "All required secrets are present"

      # ------------------------------------------------------------------
      # 3. Deploy to GREEN bucket
      # ------------------------------------------------------------------
      - name: Deploy to Green S3 Bucket
        env:
          GREEN_BUCKET: ${{ secrets.S3_BUCKET_NAME_NEW }}
        run: |
          echo "Deploying to GREEN bucket: $GREEN_BUCKET"
          aws s3 sync dist/ "s3://$GREEN_BUCKET" --delete

      # ------------------------------------------------------------------
      # 4. Determine current origin (BLUE or GREEN)
      # ------------------------------------------------------------------
      - name: Get current CloudFront config
        id: cf_config
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront get-distribution-config --id "$DIST_ID" > cf.json
          ETAG=$(jq -r .ETag cf.json)
          CURRENT=$(jq -r .DistributionConfig.DefaultCacheBehavior.TargetOriginId cf.json)

          echo "etag=$ETAG" >> $GITHUB_OUTPUT
          echo "current_origin=$CURRENT" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 5. Switch default behaviour to the *other* origin
      # ------------------------------------------------------------------
      - name: Switch CloudFront to opposite origin
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          GREEN_BUCKET: ${{ secrets.S3_BUCKET_NAME_NEW }}
          BLUE_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          REGION: ${{ secrets.AWS_REGION }}
        run: |
          GREEN_DOMAIN="${GREEN_BUCKET}.s3.${REGION}.amazonaws.com"
          BLUE_DOMAIN="${BLUE_BUCKET}.s3.${REGION}.amazonaws.com"

          # Look-up Origin IDs (they already exist)
          GREEN_ID=$(jq -r --arg d "$GREEN_DOMAIN" \
            '.DistributionConfig.Origins.Items[] | select(.DomainName==$d) | .Id' cf.json)
          BLUE_ID=$(jq -r --arg d "$BLUE_DOMAIN" \
            '.DistributionConfig.Origins.Items[] | select(.DomainName==$d) | .Id' cf.json)

          echo "Green Origin ID: $GREEN_ID"
          echo "Blue  Origin ID: $BLUE_ID"

          # Decide which one to point to
          if [[ "${{ steps.cf_config.outputs.current_origin }}" == "$GREEN_ID" ]]; then
            NEW_ID="$BLUE_ID"
            echo "Currently GREEN → switching to BLUE"
          else
            NEW_ID="$GREEN_ID"
            echo "Currently BLUE → switching to GREEN"
          fi

          # Patch the config
          jq --arg id "$NEW_ID" \
            '.DistributionConfig.DefaultCacheBehavior.TargetOriginId = $id' cf.json \
            > updated.json

          # Apply
          aws cloudfront update-distribution \
            --id "$DIST_ID" \
            --distribution-config file://updated.json \
            --if-match "${{ steps.cf_config.outputs.etag }}"

          echo "new_origin_id=$NEW_ID" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 6. Invalidate CloudFront cache
      # ------------------------------------------------------------------
      - name: Invalidate CloudFront Cache
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          ID=$(aws cloudfront create-invalidation \
                 --distribution-id "$DIST_ID" \
                 --paths "/*" \
                 --query 'Invalidation.Id' --output text)
          echo "Invalidation $ID created"

      # ------------------------------------------------------------------
      # 7. Health-check (max 5 attempts)
      # ------------------------------------------------------------------
      - name: Health Check
        id: health
        env:
          URL: ${{ secrets.CLOUDFRONT_URL }}
        run: |
          for i in {1..5}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            echo "Attempt $i – HTTP $CODE"
            [[ $CODE -eq 200 ]] && { echo "status=ok" >> $GITHUB_OUTPUT; exit 0; }
            sleep 15
          done
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      # ------------------------------------------------------------------
      # 8. Roll-back if health-check failed
      # ------------------------------------------------------------------
      - name: Rollback to previous origin
        if: steps.health.outputs.status == 'failed'
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          # Re-fetch fresh config (ETag may have changed)
          aws cloudfront get-distribution-config --id "$DIST_ID" > rollback.json
          ETAG=$(jq -r .ETag rollback.json)

          # Restore the *original* origin we recorded in step 5
          jq --arg id "${{ steps.cf_config.outputs.current_origin }}" \
            '.DistributionConfig.DefaultCacheBehavior.TargetOriginId = $id' rollback.json \
            > rollback-updated.json

          aws cloudfront update-distribution \
            --id "$DIST_ID" \
            --distribution-config file://rollback-updated.json \
            --if-match "$ETAG"

          # Invalidate again so users get the old version immediately
          aws cloudfront create-invalidation \
            --distribution-id "$DIST_ID" --paths "/*"

          echo "Rolled back to origin ${{ steps.cf_config.outputs.current_origin }}"

      # ------------------------------------------------------------------
      # 9. Success message
      # ------------------------------------------------------------------
      - name: Deployment Success
        if: steps.health.outputs.status == 'ok'
        run: |
          echo "Deployment succeeded!"
          echo "Production now served from ${{ steps.switch.outputs.new_origin_id == steps.cf_config.outputs.current_origin && 'BLUE' || 'GREEN' }} bucket"
