name: Blue-Green Deploy React App to S3

on:
  push:
    branches:
      - master
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '25'
      
      - name: Install & Build
        run: |
          npm ci
          npm run build
      
      # Deploy to GREEN bucket (new version)
      - name: Deploy to Green S3 Bucket
        run: |
          echo "ðŸŸ¢ Deploying new version to GREEN bucket..."
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_GREEN }} --delete
          echo "âœ… Deployment to GREEN bucket completed"
      
      # Switch CloudFront behavior to point to GREEN bucket
      - name: Switch CloudFront to Green Bucket
        id: switch_to_green
        run: |
          echo "ðŸ”„ Switching CloudFront origin to GREEN bucket..."
          
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          GREEN_BUCKET="${{ secrets.S3_BUCKET_GREEN }}"
          AWS_REGION="${{ secrets.AWS_REGION }}"
          
          # Construct proper S3 domain name
          GREEN_DOMAIN="${GREEN_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          
          echo "ðŸ“ Green bucket domain: $GREEN_DOMAIN"
          
          # Get current distribution config and ETag
          aws cloudfront get-distribution-config \
            --id $DISTRIBUTION_ID > current-dist.json
          
          ETAG=$(jq -r '.ETag' current-dist.json)
          
          # Update origin domain to GREEN bucket with proper format
          jq --arg domain "$GREEN_DOMAIN" \
            '.DistributionConfig.Origins.Items[0].DomainName = $domain' \
            current-dist.json | jq '.DistributionConfig' > updated-config.json
          
          # Apply the configuration change
          aws cloudfront update-distribution \
            --id $DISTRIBUTION_ID \
            --distribution-config file://updated-config.json \
            --if-match $ETAG
          
          echo "âœ… CloudFront now pointing to GREEN bucket"
      
      # Invalidate CloudFront cache
      - name: Invalidate CloudFront Cache
        run: |
          echo "ðŸ”„ Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "âœ… Cache invalidation created: $INVALIDATION_ID"
      
      # Health check on CloudFront URL
      - name: Health Check on CloudFront
        id: health_check
        run: |
          echo "â³ Waiting for CloudFront to propagate changes..."
          sleep 60
          
          CLOUDFRONT_URL="${{ secrets.CLOUDFRONT_URL }}"
          echo "ðŸ” Performing health check on: $CLOUDFRONT_URL"
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" -L "$CLOUDFRONT_URL")
            echo "ðŸ“Š Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Status Code: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… Health check passed! Deployment successful."
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Retrying in 15 seconds..."
              sleep 15
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts!"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
      
      # Rollback: Switch back to BLUE bucket if health check fails
      - name: Rollback to Blue Bucket
        if: failure()
        run: |
          echo "ðŸ”´ ROLLBACK: Health check failed, switching back to BLUE bucket..."
          
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          BLUE_BUCKET="${{ secrets.S3_BUCKET_BLUE }}"
          AWS_REGION="${{ secrets.AWS_REGION }}"
          
          # Construct proper S3 domain name for BLUE bucket
          BLUE_DOMAIN="${BLUE_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          
          echo "ðŸ“ Blue bucket domain: $BLUE_DOMAIN"
          
          # Get current distribution config and ETag
          aws cloudfront get-distribution-config \
            --id $DISTRIBUTION_ID > current-dist-rollback.json
          
          ETAG=$(jq -r '.ETag' current-dist-rollback.json)
          
          # Revert origin back to BLUE bucket with proper format
          jq --arg domain "$BLUE_DOMAIN" \
            '.DistributionConfig.Origins.Items[0].DomainName = $domain' \
            current-dist-rollback.json | jq '.DistributionConfig' > rollback-config.json
          
          # Apply rollback
          aws cloudfront update-distribution \
            --id $DISTRIBUTION_ID \
            --distribution-config file://rollback-config.json \
            --if-match $ETAG
          
          echo "ðŸ”„ Creating invalidation for rollback..."
          
          # Invalidate cache to ensure old version is served
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"
          
          echo "âœ… Rollback complete - CloudFront pointing back to BLUE bucket"
          echo "ðŸš¨ Deployment FAILED and was rolled back!"
          exit 1
      
      # Deployment successful
      - name: Deployment Success
        if: steps.health_check.outputs.status == 'success'
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "âœ… GREEN bucket is now serving production traffic"
          echo "ðŸ’¡ Previous version still available in BLUE bucket: ${{ secrets.S3_BUCKET_BLUE }}"
