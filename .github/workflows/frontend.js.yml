name: Blue-Green Deploy React App to S3

on:
  push:
    branches:
      - master
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '25'
      
      - name: Validate Required Secrets
        run: |
          echo "ðŸ” Validating required secrets..."
          
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.S3_BUCKET_NAME_NEW }}" ]; then
            MISSING_SECRETS+=("S3_BUCKET_NAME_NEW")
          fi
          
          if [ -z "${{ secrets.S3_BUCKET_NAME }}" ]; then
            MISSING_SECRETS+=("S3_BUCKET_NAME")
          fi
          
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            MISSING_SECRETS+=("AWS_REGION")
          fi
          
          if [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            MISSING_SECRETS+=("CLOUDFRONT_DISTRIBUTION_ID")
          fi
          
          if [ -z "${{ secrets.CLOUDFRONT_URL }}" ]; then
            MISSING_SECRETS+=("CLOUDFRONT_URL")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "Please add these secrets in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
          echo "ðŸ“¦ Green Bucket (NEW): ${{ secrets.S3_BUCKET_NAME_NEW }}"
          echo "ðŸ“¦ Blue Bucket (OLD): ${{ secrets.S3_BUCKET_NAME }}"
          echo "ðŸŒ Region: ${{ secrets.AWS_REGION }}"
          echo "â˜ï¸ CloudFront ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
      
      - name: Install & Build
        run: |
          npm ci
          npm run build
      
      # Deploy to GREEN bucket (new version)
      - name: Deploy to Green S3 Bucket
        run: |
          echo "ðŸŸ¢ Deploying new version to GREEN bucket..."
          GREEN_BUCKET="${{ secrets.S3_BUCKET_NAME_NEW }}"
          
          if [ -z "$GREEN_BUCKET" ]; then
            echo "âŒ ERROR: S3_BUCKET_NAME_NEW secret is not set!"
            exit 1
          fi
          
          echo "ðŸ“¦ Target bucket: $GREEN_BUCKET"
          aws s3 sync dist/ s3://${GREEN_BUCKET} --delete
          echo "âœ… Deployment to GREEN bucket completed"
      
      # Get current CloudFront configuration
      - name: Analyze CloudFront Configuration
        id: analyze_config
        run: |
          echo "ðŸ” Analyzing CloudFront configuration..."
          
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          
          # Get current distribution config
          aws cloudfront get-distribution-config \
            --id $DISTRIBUTION_ID > current-dist.json
          
          # Check current origins
          echo "ðŸ“‹ Current Origins:"
          jq -r '.DistributionConfig.Origins.Items[] | "  - ID: \(.Id), Domain: \(.DomainName)"' current-dist.json
          
          # Check default cache behavior
          echo "ðŸ“‹ Default Behavior Target:"
          CURRENT_TARGET=$(jq -r '.DistributionConfig.DefaultCacheBehavior.TargetOriginId' current-dist.json)
          echo "  - Target Origin ID: $CURRENT_TARGET"
          
          # Save for next steps
          echo "current_target=$CURRENT_TARGET" >> $GITHUB_OUTPUT
      
      # Switch CloudFront behavior to point to GREEN bucket
      - name: Switch CloudFront to Green Bucket
        id: switch_to_green
        run: |
          echo "ðŸ”„ Switching CloudFront to GREEN bucket..."
          
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          GREEN_BUCKET="${{ secrets.S3_BUCKET_NAME_NEW }}"
          BLUE_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          AWS_REGION="${{ secrets.AWS_REGION }}"
          
          # Construct proper S3 domain names
          GREEN_DOMAIN="${GREEN_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          BLUE_DOMAIN="${BLUE_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          
          echo "ðŸ“ Green bucket domain: $GREEN_DOMAIN"
          echo "ðŸ“ Blue bucket domain: $BLUE_DOMAIN"
          
          # Get current distribution config and ETag
          aws cloudfront get-distribution-config \
            --id $DISTRIBUTION_ID > current-dist.json
          
          ETAG=$(jq -r '.ETag' current-dist.json)
          echo "ðŸ“‹ Current ETag: $ETAG"
          
          # Check if we have separate origins or single origin
          ORIGIN_COUNT=$(jq '.DistributionConfig.Origins.Quantity' current-dist.json)
          echo "ðŸ“Š Number of origins: $ORIGIN_COUNT"
          
          if [ "$ORIGIN_COUNT" -eq 1 ]; then
            echo "ðŸ”§ Single origin setup - updating origin domain name"
            
            # Update the single origin's domain to GREEN bucket
            jq --arg domain "$GREEN_DOMAIN" \
              '.DistributionConfig.Origins.Items[0].DomainName = $domain' \
              current-dist.json | jq '.DistributionConfig' > updated-config.json
            
          else
            echo "ðŸ”§ Multiple origin setup - switching behavior target"
            
            # Find GREEN and BLUE origin IDs
            GREEN_ORIGIN_ID=$(jq -r --arg domain "$GREEN_DOMAIN" \
              '.DistributionConfig.Origins.Items[] | select(.DomainName == $domain) | .Id' \
              current-dist.json)
            
            BLUE_ORIGIN_ID=$(jq -r --arg domain "$BLUE_DOMAIN" \
              '.DistributionConfig.Origins.Items[] | select(.DomainName == $domain) | .Id' \
              current-dist.json)
            
            if [ -z "$GREEN_ORIGIN_ID" ]; then
              echo "âš ï¸ Green origin not found, adding it..."
              
              # Add GREEN origin if it doesn't exist
              jq --arg bucket "$GREEN_BUCKET" --arg domain "$GREEN_DOMAIN" --arg region "$AWS_REGION" \
                '.DistributionConfig.Origins.Items += [{
                  "Id": "S3-green-origin",
                  "DomainName": $domain,
                  "OriginPath": "",
                  "CustomHeaders": {"Quantity": 0},
                  "S3OriginConfig": {
                    "OriginAccessIdentity": ""
                  }
                }] | .DistributionConfig.Origins.Quantity += 1' \
                current-dist.json > temp-config.json
              
              mv temp-config.json current-dist.json
              GREEN_ORIGIN_ID="S3-green-origin"
            fi
            
            echo "ðŸŽ¯ Green Origin ID: $GREEN_ORIGIN_ID"
            echo "ðŸŽ¯ Blue Origin ID: $BLUE_ORIGIN_ID"
            
            # Update default cache behavior to point to GREEN origin
            jq --arg green_id "$GREEN_ORIGIN_ID" \
              '.DistributionConfig.DefaultCacheBehavior.TargetOriginId = $green_id' \
              current-dist.json | jq '.DistributionConfig' > updated-config.json
            
            # Save BLUE origin ID for rollback
            echo "blue_origin_id=$BLUE_ORIGIN_ID" >> $GITHUB_OUTPUT
          fi
          
          # Apply the configuration change
          aws cloudfront update-distribution \
            --id $DISTRIBUTION_ID \
            --distribution-config file://updated-config.json \
            --if-match $ETAG
          
          echo "âœ… CloudFront configuration updated to use GREEN bucket"
      
      # Invalidate CloudFront cache
      - name: Invalidate CloudFront Cache
        run: |
          echo "ðŸ”„ Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "âœ… Cache invalidation created: $INVALIDATION_ID"
      
      # Health check on CloudFront URL
      - name: Health Check on CloudFront
        id: health_check
        run: |
          echo "â³ Waiting for CloudFront to propagate changes..."
          sleep 60
          
          CLOUDFRONT_URL="${{ secrets.CLOUDFRONT_URL }}"
          echo "ðŸ” Performing health check on: $CLOUDFRONT_URL"
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" -L "$CLOUDFRONT_URL")
            echo "ðŸ“Š Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Status Code: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… Health check passed! Deployment successful."
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Retrying in 15 seconds..."
              sleep 15
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts!"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
      
      # Rollback: Switch back to BLUE bucket if health check fails
      - name: Rollback to Blue Bucket
        if: failure()
        run: |
          echo "ðŸ”´ ROLLBACK: Health check failed, switching back to BLUE bucket..."
          
          DISTRIBUTION_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          BLUE_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          AWS_REGION="${{ secrets.AWS_REGION }}"
          
          if [ -z "$BLUE_BUCKET" ]; then
            echo "âŒ ERROR: Cannot rollback - S3_BUCKET_NAME secret is not set!"
            exit 1
          fi
          
          # Construct proper S3 domain name for BLUE bucket
          BLUE_DOMAIN="${BLUE_BUCKET}.s3.${AWS_REGION}.amazonaws.com"
          
          echo "ðŸ“ Blue bucket domain: $BLUE_DOMAIN"
          
          # Get current distribution config and ETag
          aws cloudfront get-distribution-config \
            --id $DISTRIBUTION_ID > current-dist-rollback.json
          
          ETAG=$(jq -r '.ETag' current-dist-rollback.json)
          echo "ðŸ“‹ Rollback ETag: $ETAG"
          
          # Check if we have separate origins or single origin
          ORIGIN_COUNT=$(jq '.DistributionConfig.Origins.Quantity' current-dist-rollback.json)
          
          if [ "$ORIGIN_COUNT" -eq 1 ]; then
            echo "ðŸ”§ Single origin setup - reverting origin domain name"
            
            # Revert the single origin's domain back to BLUE bucket
            jq --arg domain "$BLUE_DOMAIN" \
              '.DistributionConfig.Origins.Items[0].DomainName = $domain' \
              current-dist-rollback.json | jq '.DistributionConfig' > rollback-config.json
            
          else
            echo "ðŸ”§ Multiple origin setup - switching behavior back to BLUE"
            
            # Find BLUE origin ID
            BLUE_ORIGIN_ID=$(jq -r --arg domain "$BLUE_DOMAIN" \
              '.DistributionConfig.Origins.Items[] | select(.DomainName == $domain) | .Id' \
              current-dist-rollback.json)
            
            if [ -z "$BLUE_ORIGIN_ID" ]; then
              echo "âŒ ERROR: Cannot find BLUE origin for rollback!"
              exit 1
            fi
            
            echo "ðŸŽ¯ Rolling back to Blue Origin ID: $BLUE_ORIGIN_ID"
            
            # Update default cache behavior to point back to BLUE origin
            jq --arg blue_id "$BLUE_ORIGIN_ID" \
              '.DistributionConfig.DefaultCacheBehavior.TargetOriginId = $blue_id' \
              current-dist-rollback.json | jq '.DistributionConfig' > rollback-config.json
          fi
          
          # Apply rollback
          aws cloudfront update-distribution \
            --id $DISTRIBUTION_ID \
            --distribution-config file://rollback-config.json \
            --if-match $ETAG
          
          echo "ðŸ”„ Creating invalidation for rollback..."
          
          # Invalidate cache to ensure old version is served
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"
          
          echo "âœ… Rollback complete - CloudFront pointing back to BLUE bucket"
          echo "ðŸš¨ Deployment FAILED and was rolled back!"
          exit 1
      
      # Deployment successful
      - name: Deployment Success
        if: steps.health_check.outputs.status == 'success'
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "âœ… GREEN bucket is now serving production traffic"
          echo "ðŸ’¡ Previous version still available in BLUE bucket: ${{ secrets.S3_BUCKET_NAME }}"
