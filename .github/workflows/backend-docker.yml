name: Deploy Backend via CodeDeploy

on:
  push:
    branches:
      - master   # Trigger only when backend branch is pushed
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
      # ──────────────────────────────
      # CHECKOUT REPOSITORY
      # ──────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ──────────────────────────────
      # ZIP BACKEND AND APPSPEC FILES
      # ──────────────────────────────
      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          cd backend
          zip -r ../cd.zip . ../appspec.yml ../scripts
          cd ..
          ls -lh cd.zip

      # ──────────────────────────────
      # UPLOAD ZIP TO S3
      # ──────────────────────────────
      - name: Upload Artifact to S3
        run: |
          echo "Uploading cd.zip to S3..."
          aws s3 cp cd.zip s3://code-deployy1143/cd.zip
          echo "Upload complete."

      # ──────────────────────────────
      # TRIGGER CODEDEPLOY DEPLOYMENT
      # ──────────────────────────────
      - name: Trigger CodeDeploy Deployment
        id: deploy
        run: |
          echo "Triggering AWS CodeDeploy deployment..."
          DEPLOY_ID=$(aws deploy create-deployment \
            --application-name "${{ secrets.CODEDEPLOY_APPLICATION }}" \
            --deployment-group-name "${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }}" \
            --s3-location bucket=code-deployy1143,key=cd.zip,bundleType=zip \
            --description "Deployment from GitHub Actions - ${{ github.sha }}" \
            --query 'deploymentId' --output text)

          echo "Deployment ID: $DEPLOY_ID"
          echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      # ──────────────────────────────
      # WAIT FOR DEPLOYMENT TO COMPLETE
      # ──────────────────────────────
      - name: Wait for CodeDeploy Success
        if: success()
        run: |
          echo "Waiting for CodeDeploy deployment to complete..."
          aws deploy wait deployment-successful --deployment-id "${{ steps.deploy.outputs.deployment_id }}"
          echo "✅ Deployment succeeded!"

      # ──────────────────────────────
      # HANDLE FAILURES
      # ──────────────────────────────
      - name: Deployment Failed
        if: failure()
        run: |
          echo "❌ Deployment failed or timed out!"
          echo "Check CodeDeploy console:"
          echo "https://console.aws.amazon.com/codedeploy/home#/deployments/${{ steps.deploy.outputs.deployment_id }}"
          exit 1
