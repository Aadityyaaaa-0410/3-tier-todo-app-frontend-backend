name: Deploy Backend via CodeDeploy

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      # ──────────────────────────────
      # CHECKOUT REPOSITORY
      # ──────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ──────────────────────────────
      # BUILD & PUSH DOCKER IMAGE TO ECR
      # ──────────────────────────────
      - name: Build and Push Docker Image to ECR
        run: |
          echo "Logging in to Amazon ECR..."
          aws ecr get-login-password --region $AWS_REGION \
            | sudo docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

          echo "Building Docker image..."
          cd backend
          sudo docker build -t fullstack-project .

          echo "Tagging image..."
          sudo docker tag fullstack-project:latest ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

          echo "Pushing image to ECR..."
          sudo docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

          echo "✅ Docker image pushed successfully!"

      # ──────────────────────────────
      # CREATE DEPLOYMENT PACKAGE
      # ──────────────────────────────
      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          cd backend
          cd ..
          zip -r cd.zip backend
          echo "✅ Zip package created: cd.zip"

      # ──────────────────────────────
      # UPLOAD ZIP TO S3
      # ──────────────────────────────
      - name: Upload Artifact to S3
        run: |
          echo "Uploading cd.zip to S3..."
          aws s3 cp cd.zip s3://${{ secrets.S3_BUCKET_NAME }}/cd.zip
          echo "✅ Upload complete."

      # ──────────────────────────────
      # TRIGGER CODEDEPLOY DEPLOYMENT
      # ──────────────────────────────
      - name: Trigger CodeDeploy Deployment
        id: deploy
        run: |
          echo "Triggering AWS CodeDeploy deployment..."
          DEPLOY_ID=$(aws deploy create-deployment \
            --application-name "${{ secrets.CODEDEPLOY_APPLICATION }}" \
            --deployment-group-name "${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }}" \
            --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},key=cd.zip,bundleType=zip \
            --description "Deployment from GitHub Actions - ${{ github.sha }}" \
            --query 'deploymentId' --output text)

          echo "Deployment ID: $DEPLOY_ID"
          echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      # ──────────────────────────────
      # WAIT FOR DEPLOYMENT SUCCESS
      # ──────────────────────────────
      - name: Wait for CodeDeploy Success
        if: success()
        run: |
          echo "Waiting for CodeDeploy deployment to complete..."
          aws deploy wait deployment-successful --deployment-id "${{ steps.deploy.outputs.deployment_id }}"
          echo "✅ Deployment succeeded!"

      # ──────────────────────────────
      # CLEANUP DOCKER IMAGES
      # ──────────────────────────────
      - name: Clean up Docker images
        if: always()
        run: |
          echo "Cleaning up local Docker images..."
          sudo docker rmi fullstack-project:latest || true
          sudo docker rmi ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest || true
          sudo docker image prune -f || true
          echo "✅ Cleanup complete"

      # ──────────────────────────────
      # HANDLE FAILURES
      # ──────────────────────────────
      - name: Deployment Failed
        if: failure()
        run: |
          echo "❌ Deployment failed or timed out!"
          echo "Check CodeDeploy console:"
          echo "https://console.aws.amazon.com/codedeploy/home#/deployments/${{ steps.deploy.outputs.deployment_id }}"
          exit 1
