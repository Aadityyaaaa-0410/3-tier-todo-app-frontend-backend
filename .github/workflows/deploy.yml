name: Deploy Backend via CodeDeploy

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'

permissions:
  id-token: write       # For OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      # ------------------------
      # 1. Checkout Repository
      # ------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------------
      # 2. Configure AWS via OIDC
      # ------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ------------------------
      # 3. Build & Push Docker Image to ECR
      # ------------------------
      - name: Build and Push Docker Image
        run: |
          echo "Logging in to Amazon ECR..."
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

          echo "Building Docker image..."
          cd backend
          docker build -t fullstack-project .

          echo "Tagging image..."
          docker tag fullstack-project:latest ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

          echo "Pushing image to ECR..."
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

          echo "âœ… Docker image pushed successfully!"
          cd ..

      # ------------------------
      # 4. Fetch latest image URI from ECR
      # ------------------------
      - name: Fetch latest ECR image URI
        id: ecr_image
        run: |
          LATEST_TAG=$(aws ecr describe-images \
            --repository-name ${{ secrets.ECR_REPOSITORY }} \
            --query "sort_by(imageDetails, &imagePushedAt)[-1].imageTags[0]" \
            --output text)

          IMAGE_URI="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:$LATEST_TAG"
          echo "Latest pushed tag: $LATEST_TAG"
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

      # ------------------------
      # 5. Register new ECS task-definition revision
      # ------------------------
      - name: Register new ECS task definition revision
        id: taskdef
        run: |
          NEW_TASKDEF_ARN=$(aws ecs register-task-definition \
            --family ${{ secrets.ECS_TASK_FAMILY }} \
            --container-definitions "[{\"name\":\"${{ secrets.ECS_CONTAINER_NAME }}\",\"image\":\"${{ steps.ecr_image.outputs.image_uri }}\",\"portMappings\":[{\"containerPort\":${{ secrets.ECS_CONTAINER_PORT }},\"protocol\":\"tcp\"}],\"essential\":true}]" \
            --requires-compatibilities FARGATE \
            --cpu 256 --memory 512 \
            --network-mode awsvpc \
            --execution-role-arn ${{ secrets.ECS_EXEC_ROLE }} \
            --task-role-arn ${{ secrets.ECS_TASK_ROLE }} \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "new_taskdef_arn=$NEW_TASKDEF_ARN" >> $GITHUB_OUTPUT
          echo "âœ… New Task Definition Registered: $NEW_TASKDEF_ARN"

      # ------------------------
      # 6. Generate appspec.json for CodeDeploy ECS Blue/Green
      # ------------------------
      - name: Generate appspec.json
        run: |
          cat <<EOF > appspec.json
          {
            "version": "0.0",
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "${{ steps.taskdef.outputs.new_taskdef_arn }}",
                    "LoadBalancerInfo": {
                      "ContainerName": "${{ secrets.ECS_CONTAINER_NAME }}",
                      "ContainerPort": ${{ secrets.ECS_CONTAINER_PORT }}
                    }
                  }
                }
              }
            ]
          }
          EOF

          echo "âœ… AppSpec JSON created successfully!"
          cat appspec.json | jq .

      # ------------------------
      # 7. Trigger CodeDeploy deployment to ECS
      # ------------------------
      - name: Deploy via CodeDeploy ECS Blue/Green
        run: |
          aws deploy create-deployment \
            --application-name ${{ secrets.CODEDEPLOY_APP }} \
            --deployment-group-name ${{ secrets.CODEDEPLOY_GROUP }} \
            --revision revisionType=AppSpecContent,appSpecContent="{content=$(jq -c . appspec.json)}" \
            --region $AWS_REGION

          echo "ðŸš€ âœ… Deployment triggered successfully!"
